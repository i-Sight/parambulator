<!DOCTYPE html>

<html>
<head>
  <title>parambulator.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>parambulator.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/* Copyright (c) 2012-2015 Richard Rodger, MIT License */</span>
<span class="hljs-comment">/* jshint node:true, asi:true, eqnull:true */</span>

(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">  &quot;use strict&quot;</span>;

  <span class="hljs-keyword">var</span> root           = <span class="hljs-built_in">this</span>
  <span class="hljs-keyword">var</span> previous_parambulator = root.parambulator

  <span class="hljs-keyword">var</span> has_require = <span class="hljs-keyword">typeof</span> <span class="hljs-built_in">require</span> !== <span class="hljs-string">&#x27;undefined&#x27;</span>


  <span class="hljs-keyword">var</span> _      = root._
  <span class="hljs-keyword">var</span> gex    = root.gex
  <span class="hljs-keyword">var</span> jsonic = root.jsonic


  <span class="hljs-keyword">if</span>( <span class="hljs-keyword">typeof</span> _ === <span class="hljs-string">&#x27;undefined&#x27;</span> ) {
    <span class="hljs-keyword">if</span>( has_require ) {
      _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;lodash&#x27;</span>)
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>assume in web context, so still underscore, not lodash</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">&#x27;parambulator requires underscore, see http://underscorejs.org&#x27;</span>);
  }

  <span class="hljs-keyword">if</span>( <span class="hljs-keyword">typeof</span> gex === <span class="hljs-string">&#x27;undefined&#x27;</span> ) {
    <span class="hljs-keyword">if</span>( has_require ) {
      gex = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;gex&#x27;</span>)
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">&#x27;parambulator requires gex, see http://github.com/rjrodger/gex&#x27;</span>);
  }

  <span class="hljs-keyword">if</span>( <span class="hljs-keyword">typeof</span> jsonic === <span class="hljs-string">&#x27;undefined&#x27;</span> ) {
    <span class="hljs-keyword">if</span>( has_require ) {
      jsonic = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;jsonic&#x27;</span>)
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">&#x27;parambulator requires jsonic, see http://github.com/rjrodger/jsonic&#x27;</span>);
  }



  <span class="hljs-keyword">var</span> arrayify = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{ <span class="hljs-keyword">return</span> <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>],<span class="hljs-built_in">arguments</span>[<span class="hljs-number">1</span>]) }


  <span class="hljs-keyword">var</span> quantrule = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"> pass, rulename </span>) </span>{
    rulename = rulename || <span class="hljs-string">&#x27;quantrule&#x27;</span>

    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ctxt,cb</span>) </span>{
      ctxt.prop = <span class="hljs-literal">null</span>

      <span class="hljs-keyword">var</span> pn = ctxt.util.proplist(ctxt)

      <span class="hljs-keyword">var</span> found = <span class="hljs-number">0</span>
      _.each(pn, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">p</span>)</span>{
        found += ctxt.point[p]?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>
      })

      <span class="hljs-keyword">if</span>( !pass(found) ) {
        ctxt.value = <span class="hljs-string">&#x27;&#x27;</span>+pn
        <span class="hljs-keyword">return</span> ctxt.util.fail(ctxt,cb)
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> cb();
    }
  }

  <span class="hljs-keyword">var</span> lenrule = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"> pass </span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ctxt,cb</span>) </span>{
      <span class="hljs-keyword">var</span> len = ctxt.rule.spec
      <span class="hljs-keyword">var</span> value = ctxt.point

      <span class="hljs-keyword">if</span>( !_.isUndefined(value) ) {
        <span class="hljs-keyword">var</span> valuelen = _.isObject(value) ? <span class="hljs-built_in">Object</span>.keys(value).length : value.length
        <span class="hljs-keyword">if</span> ( !_.isUndefined( valuelen ) ){
          <span class="hljs-keyword">if</span> ( !pass( valuelen, len ) ) {
            <span class="hljs-keyword">return</span> ctxt.util.fail(ctxt,cb)
          }
        }
      }

      <span class="hljs-keyword">return</span> cb()
    }
  };


  <span class="hljs-keyword">var</span> childrule = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"> pass, noneok, rulename </span>) </span>{
    rulename = rulename || <span class="hljs-string">&#x27;childrule&#x27;</span>

    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ctxt,cb</span>) </span>{
      <span class="hljs-keyword">var</span> pn = ctxt.util.proplist(ctxt)

      <span class="hljs-keyword">for</span>( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; pn.length; i++ ) {
        <span class="hljs-keyword">var</span> p = pn[i]
        ctxt.prop = p

        <span class="hljs-keyword">var</span> v = ctxt.point[p]

        <span class="hljs-keyword">if</span>( !pass(ctxt,p,v) ) {
          ctxt.value = v
          <span class="hljs-keyword">return</span> ctxt.util.fail(ctxt,cb)
        }
      }

      <span class="hljs-keyword">if</span>( <span class="hljs-number">0</span> === pn.length ) {
        <span class="hljs-keyword">if</span>( !noneok() ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>TODO needs a separate msg code</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          ctxt.prop = <span class="hljs-built_in">JSON</span>.stringify(ctxt.rule.spec,killcircles())
          <span class="hljs-keyword">return</span> ctxt.util.fail(ctxt,cb)
        }
      }
      cb();
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">proplist</span>(<span class="hljs-params">ctxt</span>) </span>{
    <span class="hljs-keyword">var</span> pn = ctxt.rule.spec</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>TODO: handle comma separated strings
<a href="https://github.com/rjrodger/parambulator/issues/19">https://github.com/rjrodger/parambulator/issues/19</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">if</span>( !_.isArray(pn) ) {
      pn = [<span class="hljs-string">&#x27;&#x27;</span>+pn]
    }

    <span class="hljs-keyword">var</span> all = []
    _.each(pn, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">n</span>)</span>{

      <span class="hljs-keyword">if</span>( n.match( <span class="hljs-regexp">/[*?]/</span> ) ) {
        all = all.concat( _.keys(gex(n).on(ctxt.point)) )
      }
      <span class="hljs-keyword">else</span> all.push(n);
    })

    <span class="hljs-keyword">return</span> all
  }


  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">truefn</span>(<span class="hljs-params"></span>)</span>{<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>}
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">falsefn</span>(<span class="hljs-params"></span>)</span>{<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>}
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">noval</span>(<span class="hljs-params">v</span>)</span>{<span class="hljs-keyword">return</span> _.isUndefined(v)||_.isNull(v)}

  <span class="hljs-keyword">var</span> valrule = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"> pass </span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ctxt,cb</span>) </span>{
      <span class="hljs-keyword">var</span> v = ctxt.point
      <span class="hljs-keyword">var</span> p = ctxt.rule.spec
      <span class="hljs-keyword">if</span>( !_.isUndefined(v) ) {
        <span class="hljs-keyword">if</span>( !pass(v, p) ) {
          <span class="hljs-keyword">return</span> ctxt.util.fail(ctxt,cb)
        }
      }

      <span class="hljs-keyword">return</span> cb();
    }
  }


  <span class="hljs-keyword">var</span> rulemap = {

    <span class="hljs-attr">atmostone$</span>:  quantrule( <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">f</span>)</span>{<span class="hljs-keyword">return</span> f&lt;=<span class="hljs-number">1</span>}, <span class="hljs-string">&#x27;atmostone$&#x27;</span>),
    <span class="hljs-attr">exactlyone$</span>: quantrule( <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">f</span>)</span>{<span class="hljs-keyword">return</span> <span class="hljs-number">1</span>==f}, <span class="hljs-string">&#x27;exactlyone$&#x27;</span>),
    <span class="hljs-attr">atleastone$</span>: quantrule( <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">f</span>)</span>{<span class="hljs-keyword">return</span> <span class="hljs-number">1</span>&lt;=f}, <span class="hljs-string">&#x27;atleastone$&#x27;</span>),


    <span class="hljs-attr">required$</span>: childrule( <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ctxt,p,v</span>)</span>{<span class="hljs-keyword">return</span> !_.isUndefined(v)}, falsefn, <span class="hljs-string">&#x27;required$&#x27;</span> ),

    <span class="hljs-attr">notempty$</span>: childrule(
      <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ctxt,p,v</span>)</span>{
        <span class="hljs-keyword">return</span> !_.isUndefined(v) &amp;&amp; !_.isNull(v) &amp;&amp; <span class="hljs-string">&#x27;&#x27;</span> !== v
      },
      truefn,
      <span class="hljs-string">&#x27;notempty$&#x27;</span>
    ),

    <span class="hljs-attr">string$</span>:   childrule( <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ctxt,p,v</span>)</span>{<span class="hljs-keyword">return</span> noval(v) || _.isString(v)}, truefn, <span class="hljs-string">&#x27;string$&#x27;</span> ),
    <span class="hljs-attr">integer$</span>:  childrule( <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ctxt,p,v</span>)</span>{<span class="hljs-keyword">return</span> noval(v) || _.isNumber(v) &amp;&amp; v===(v|<span class="hljs-number">0</span>)}, truefn, <span class="hljs-string">&#x27;integer$&#x27;</span> ),
    <span class="hljs-attr">number$</span>:   childrule( <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ctxt,p,v</span>)</span>{<span class="hljs-keyword">return</span> noval(v) || _.isNumber(v)}, truefn, <span class="hljs-string">&#x27;number$&#x27;</span> ),
    <span class="hljs-attr">boolean$</span>:  childrule( <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ctxt,p,v</span>)</span>{<span class="hljs-keyword">return</span> noval(v) || _.isBoolean(v)}, truefn, <span class="hljs-string">&#x27;boolean$&#x27;</span> ),
    <span class="hljs-attr">date$</span>:     childrule( <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ctxt,p,v</span>)</span>{<span class="hljs-keyword">return</span> noval(v) || _.isDate(v)}, truefn, <span class="hljs-string">&#x27;date$&#x27;</span> ),
    <span class="hljs-attr">array$</span>:    childrule( <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ctxt,p,v</span>)</span>{<span class="hljs-keyword">return</span> noval(v) || _.isArray(v)}, truefn, <span class="hljs-string">&#x27;array$&#x27;</span> ),
    <span class="hljs-attr">object$</span>:   childrule( <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ctxt,p,v</span>)</span>{<span class="hljs-keyword">return</span> noval(v) || _.isObject(v) &amp;&amp; !_.isArray(v)}, truefn, <span class="hljs-string">&#x27;object$&#x27;</span> ),
    <span class="hljs-attr">function$</span>: childrule( <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ctxt,p,v</span>)</span>{<span class="hljs-keyword">return</span> noval(v) || _.isFunction(v)}, truefn, <span class="hljs-string">&#x27;function$&#x27;</span> ),

    <span class="hljs-attr">lt$</span>:  valrule( <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">p,v</span>)</span>{<span class="hljs-keyword">return</span> p &lt; v} ),
    <span class="hljs-attr">lte$</span>: valrule( <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">p,v</span>)</span>{<span class="hljs-keyword">return</span> p &lt;= v} ),
    <span class="hljs-attr">gt$</span>:  valrule( <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">p,v</span>)</span>{<span class="hljs-keyword">return</span> p &gt; v} ),
    <span class="hljs-attr">gte$</span>: valrule( <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">p,v</span>)</span>{<span class="hljs-keyword">return</span> p &gt;= v} ),

    <span class="hljs-attr">min$</span>: valrule( <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">p,v</span>)</span>{<span class="hljs-keyword">return</span> p &gt;= v}),
    <span class="hljs-attr">max$</span>: valrule( <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">p,v</span>)</span>{<span class="hljs-keyword">return</span> p &lt;= v}),

    <span class="hljs-attr">uniq$</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ctxt,cb</span>)</span>{
      <span class="hljs-keyword">var</span> value = ctxt.point
      <span class="hljs-keyword">var</span> o = {}

      <span class="hljs-keyword">for</span>( <span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i&lt;value.length;i++ ) {
        <span class="hljs-keyword">if</span>(_.has(o, value[i])){
          <span class="hljs-keyword">return</span> ctxt.util.fail(ctxt,cb)
        } <span class="hljs-keyword">else</span> {
          o[value[i]]= <span class="hljs-number">1</span>
        }
      }

      <span class="hljs-keyword">return</span> cb()
    },

    <span class="hljs-attr">only$</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ctxt,cb</span>) </span>{
      <span class="hljs-keyword">var</span> pn = ctxt.util.proplist(ctxt)

      <span class="hljs-keyword">for</span>( <span class="hljs-keyword">var</span> p <span class="hljs-keyword">in</span> ctxt.point ) {
        <span class="hljs-keyword">if</span>( !(_.includes||_.contains)(pn,p) ) {
          ctxt.prop = p
          <span class="hljs-keyword">return</span> ctxt.util.fail(ctxt,cb)
        }
      }

      <span class="hljs-keyword">return</span> cb();
    },


    <span class="hljs-attr">wild$</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ctxt,cb</span>) </span>{
      <span class="hljs-keyword">var</span> value = ctxt.point

      <span class="hljs-keyword">if</span>( !_.isUndefined(value) ) {
        <span class="hljs-keyword">if</span>( !gex(ctxt.rule.spec).on(value) ) {
          <span class="hljs-keyword">return</span> ctxt.util.fail(ctxt,cb)
        }
      }

      <span class="hljs-keyword">return</span> cb();
    },


    <span class="hljs-attr">eq$</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ctxt,cb</span>) </span>{
      <span class="hljs-keyword">var</span> value = ctxt.point

      <span class="hljs-keyword">if</span>( !_.isUndefined(value) ) {
        <span class="hljs-keyword">if</span>( ctxt.rule.spec !== value ) {
          <span class="hljs-keyword">return</span> ctxt.util.fail(ctxt,cb)
        }
      }

      <span class="hljs-keyword">return</span> cb();
    },

    <span class="hljs-attr">minlen$</span>: lenrule( <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">valuelen, conditionlen</span>)</span>{<span class="hljs-keyword">return</span> valuelen &gt;= conditionlen} ),
    <span class="hljs-attr">maxlen$</span>: lenrule( <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">valuelen, conditionlen</span>)</span>{<span class="hljs-keyword">return</span> valuelen &lt;= conditionlen} ),

    <span class="hljs-attr">re$</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ctxt,cb</span>) </span>{
      <span class="hljs-keyword">var</span> value = ctxt.point

      <span class="hljs-keyword">if</span>( !_.isUndefined(value) ) {
        value = <span class="hljs-string">&#x27;&#x27;</span>+value
        <span class="hljs-keyword">var</span> redef = ctxt.rule.spec
        <span class="hljs-keyword">var</span> reopt = <span class="hljs-keyword">void</span>(<span class="hljs-number">0</span>)

        <span class="hljs-keyword">var</span> m = <span class="hljs-regexp">/^\/(.*)\/(\w*)$/</span>.exec(ctxt.rule.spec)
        <span class="hljs-keyword">if</span>( m ) {
          redef = m[<span class="hljs-number">1</span>]
          reopt = m[<span class="hljs-number">2</span>]
        }

        <span class="hljs-keyword">var</span> re = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(redef,reopt)

        <span class="hljs-keyword">if</span>( !re.exec(value) ) {
          <span class="hljs-keyword">return</span> ctxt.util.fail(ctxt,cb)
        }
      }

      <span class="hljs-keyword">return</span> cb();
    },


    <span class="hljs-attr">type$</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ctxt,cb</span>) </span>{
      <span class="hljs-keyword">var</span> pn = ctxt.util.proplist(ctxt)

      <span class="hljs-keyword">var</span> checkmap = {
        <span class="hljs-attr">string</span>:_.isString,
        <span class="hljs-attr">number</span>:_.isNumber,
        <span class="hljs-attr">integer</span>:<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">v</span>)</span>{<span class="hljs-keyword">return</span> _.isNumber(v) &amp;&amp; v===(v|<span class="hljs-number">0</span>)},
        <span class="hljs-attr">boolean</span>:_.isBoolean,
        <span class="hljs-attr">date</span>:_.isDate,
        <span class="hljs-attr">array</span>:_.isArray,
        <span class="hljs-attr">object</span>:<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">v</span>)</span>{<span class="hljs-keyword">return</span> _.isObject(v) &amp;&amp; !_.isArray(v) &amp;&amp; !_.isDate(v)},
        <span class="hljs-string">&#x27;function&#x27;</span>:<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">v</span>)</span>{<span class="hljs-keyword">return</span> _.isFunction(v)}
      }

      <span class="hljs-keyword">var</span> found = <span class="hljs-number">0</span>;
      _.each(pn, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">p</span>)</span>{
        <span class="hljs-keyword">var</span> check = checkmap[p.toLowerCase()]
        <span class="hljs-keyword">if</span>( check ) {
          found += check(ctxt.point)
        }
      })

      <span class="hljs-keyword">if</span>( !found ) {
        <span class="hljs-keyword">return</span> ctxt.util.fail(ctxt,cb)
      }

      <span class="hljs-keyword">return</span> cb();
    },

    <span class="hljs-attr">format$</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ctxt,cb</span>) </span>{
      <span class="hljs-keyword">var</span> pn = ctxt.util.proplist(ctxt)

      <span class="hljs-keyword">var</span> checkmap = {
        <span class="hljs-attr">datetime</span>:    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkFormatRegex</span>(<span class="hljs-params">v</span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-regexp">/\d{4}-(0[1-9]|1[1-2])-([0-2]\d|3[0-1])T([0-1]\d|2[0-4]):[0-5]\d:[0-5]\dZ/</span>.test(v) },
        <span class="hljs-attr">date</span>:        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkFormatRegex</span>(<span class="hljs-params">v</span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-regexp">/\d{4}-[0-1][0-2]-[0-2]\d/</span>.test(v) },
        <span class="hljs-attr">time</span>:        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkFormatRegex</span>(<span class="hljs-params">v</span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-regexp">/([0-1]\d|2[0-4]):[0-5]\d:[0-5]\dZ/</span>.test(v) },
        <span class="hljs-attr">utcmillisec</span>: _.isNumber,
        <span class="hljs-attr">re</span>:          _.isRegExp
      }

      <span class="hljs-keyword">var</span> found = <span class="hljs-number">0</span>;
      _.each(pn, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">p</span>)</span>{
        <span class="hljs-keyword">var</span> check = checkmap[p.toLowerCase()]
        <span class="hljs-keyword">if</span>( check ) {
          found += check(ctxt.point)
        }
      })

      <span class="hljs-keyword">if</span>( !found ) {
        <span class="hljs-keyword">return</span> ctxt.util.fail(ctxt,cb)
      }

      <span class="hljs-keyword">return</span> cb();
    },

    <span class="hljs-attr">default$</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ctxt,cb</span>) </span>{
      <span class="hljs-keyword">return</span> cb();
    },

    <span class="hljs-attr">enum$</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ctxt,cb</span>) </span>{
      <span class="hljs-keyword">var</span> value = ctxt.point
      <span class="hljs-keyword">var</span> okvals = ctxt.rule.spec

      <span class="hljs-keyword">var</span> avalue = []

      <span class="hljs-keyword">if</span> ( _.isArray(value) ) {
        avalue = value
      }
      <span class="hljs-keyword">else</span> {
        avalue[<span class="hljs-number">0</span>] = value
      }

      <span class="hljs-keyword">var</span> iserror = <span class="hljs-number">0</span>
      <span class="hljs-keyword">if</span>( avalue ) {
        _.each(avalue, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">p</span>)</span>{
          iserror += (<span class="hljs-number">-1</span> == okvals.indexOf(p) )
        })
      }
      <span class="hljs-keyword">if</span> ( iserror ){
        <span class="hljs-keyword">return</span> ctxt.util.fail(ctxt,cb)
      }

      <span class="hljs-keyword">return</span> cb();
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>internal rules</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>

    <span class="hljs-attr">iterate$</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ctxt,cb</span>) </span>{
      <span class="hljs-keyword">var</span> pn = [ctxt.rule.spec.prop]

      <span class="hljs-keyword">if</span>( _.isObject(ctxt.point) ) {
        <span class="hljs-keyword">if</span>( _.isArray(ctxt.point) ) {
          pn = gex( ctxt.rule.spec.prop ).on( _.range(ctxt.point.length))
        }
        <span class="hljs-keyword">else</span> {
          pn = _.keys(gex( ctxt.rule.spec.prop ).on(ctxt.point))
        }
      }

      <span class="hljs-keyword">var</span> subctxt = ctxt.util.clone(ctxt)
      subctxt.rules = ctxt.rule.spec.rules

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">eachprop</span>(<span class="hljs-params">propI</span>) </span>{
        <span class="hljs-keyword">if</span>( propI &lt; pn.length ) {
          <span class="hljs-keyword">var</span> p = pn[propI]

          <span class="hljs-keyword">var</span> psubctxt = ctxt.util.clone(subctxt)

          psubctxt.parents = subctxt.parents.concat({<span class="hljs-attr">prop</span>:p,<span class="hljs-attr">point</span>:subctxt.point})

          psubctxt.prop  = p
          psubctxt.point = subctxt.point ? subctxt.point[p] : <span class="hljs-literal">null</span>

          psubctxt.util.execrules(psubctxt,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>)</span>{
            <span class="hljs-keyword">if</span>( err ) <span class="hljs-keyword">return</span> cb(err);
            eachprop(propI+<span class="hljs-number">1</span>)
          })
        }
        <span class="hljs-keyword">else</span> cb()
      }
      eachprop(<span class="hljs-number">0</span>)
    },


    <span class="hljs-attr">recurse$</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ctxt,cb</span>) </span>{

      <span class="hljs-keyword">var</span> recurctxt = ctxt.util.clone(ctxt)
      recurctxt.point = {<span class="hljs-attr">$</span>:ctxt.point}
      recurse(<span class="hljs-string">&#x27;$&#x27;</span>,recurctxt.point,cb)

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">recurse</span>(<span class="hljs-params">prop,point,cb</span>) </span>{
        <span class="hljs-keyword">if</span>( !_.isObject(point) ) {
          <span class="hljs-keyword">return</span> cb(<span class="hljs-literal">null</span>)
        }

        <span class="hljs-keyword">var</span> pn = _.keys( point )

        <span class="hljs-keyword">var</span> subctxt = ctxt.util.clone(ctxt)
        subctxt.rules   = ctxt.rule.spec.rules
        subctxt.parents = <span class="hljs-string">&#x27;$&#x27;</span>!=prop?subctxt.parents.concat({<span class="hljs-attr">prop</span>:subctxt.prop,<span class="hljs-attr">point</span>:subctxt.point}):subctxt.parents

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">eachprop</span>(<span class="hljs-params">propI,cb</span>) </span>{
          <span class="hljs-keyword">if</span>( propI &lt; pn.length ) {
            <span class="hljs-keyword">var</span> p = pn[propI]
            <span class="hljs-keyword">var</span> eachpropctxt = subctxt.util.clone(subctxt)
            eachpropctxt.prop  = p
            eachpropctxt.point = point[p]
            eachpropctxt.parents = <span class="hljs-string">&#x27;$&#x27;</span>!=p?eachpropctxt.parents.concat({<span class="hljs-attr">prop</span>:subctxt.prop,<span class="hljs-attr">point</span>:subctxt.point}):eachpropctxt.parents

            eachpropctxt.util.execrules(eachpropctxt,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>)</span>{
              <span class="hljs-keyword">if</span>( err ) <span class="hljs-keyword">return</span> cb(err);

              recurse(p,eachpropctxt.point,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>)</span>{
                <span class="hljs-keyword">if</span>( err ) <span class="hljs-keyword">return</span> cb(err);

                eachprop(propI+<span class="hljs-number">1</span>,cb)
              })
            })
          }
          <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> cb(<span class="hljs-literal">null</span>)
          }
        }
        eachprop(<span class="hljs-number">0</span>,cb)
      }
    },


    <span class="hljs-attr">descend$</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ctxt,cb</span>) </span>{
      <span class="hljs-keyword">var</span> subctxt = ctxt.util.clone(ctxt)
      <span class="hljs-keyword">var</span> prop = ctxt.rule.spec.prop

      subctxt.rules   = ctxt.rule.spec.rules
      subctxt.prop    = prop
      subctxt.point   = ctxt.point[prop]
      subctxt.parents = subctxt.parents.concat({<span class="hljs-attr">prop</span>:prop,<span class="hljs-attr">point</span>:ctxt.point})

      subctxt.util.execrules(subctxt,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>)</span>{
        <span class="hljs-keyword">if</span>( err ) <span class="hljs-keyword">return</span> cb(err);
        cb(<span class="hljs-literal">null</span>)
      })
    }
  }


  <span class="hljs-keyword">var</span> msgsmap = {
    <span class="hljs-attr">no_input$</span>:   <span class="hljs-string">&quot;There is no input parameter&quot;</span>,

    <span class="hljs-attr">atmostone$</span>:  <span class="hljs-string">&quot;At most one of these properties can be used at a time: &#x27;&lt;%=value%&gt;&#x27;  (parent: &lt;%=parentpath%&gt;).&quot;</span>,
    <span class="hljs-attr">exactlyone$</span>: <span class="hljs-string">&quot;Exactly one of these properties must be used: &#x27;&lt;%=value%&gt;&#x27; (parent: &lt;%=parentpath%&gt;).&quot;</span>,
    <span class="hljs-attr">atleastone$</span>: <span class="hljs-string">&quot;At least one of these properties is required: &#x27;&lt;%=value%&gt;&#x27; (parent: &lt;%=parentpath%&gt;).&quot;</span>,

    <span class="hljs-attr">required$</span>:   <span class="hljs-string">&quot;The property &#x27;&lt;%=property%&gt;&#x27; is missing and is always required (parent: &lt;%=parentpath%&gt;).&quot;</span>,
    <span class="hljs-attr">notempty$</span>:   <span class="hljs-string">&quot;The property &#x27;&lt;%=property%&gt;&#x27; requires a value (parent: &lt;%=parentpath%&gt;).&quot;</span>,

    <span class="hljs-attr">string$</span>:     <span class="hljs-string">&quot;The property &#x27;&lt;%=property%&gt;&#x27;, with current value: &#x27;&lt;%=value%&gt;&#x27;, must be a string (parent: &lt;%=parentpath%&gt;).&quot;</span>,
    <span class="hljs-attr">integer$</span>:    <span class="hljs-string">&quot;The property &#x27;&lt;%=property%&gt;&#x27;, with current value: &#x27;&lt;%=value%&gt;&#x27;, must be a integer (parent: &lt;%=parentpath%&gt;).&quot;</span>,
    <span class="hljs-attr">number$</span>:     <span class="hljs-string">&quot;The property &#x27;&lt;%=property%&gt;&#x27;, with current value: &#x27;&lt;%=value%&gt;&#x27;, must be a number (parent: &lt;%=parentpath%&gt;).&quot;</span>,
    <span class="hljs-attr">boolean$</span>:    <span class="hljs-string">&quot;The property &#x27;&lt;%=property%&gt;&#x27;, with current value: &#x27;&lt;%=value%&gt;&#x27;, must be a boolean (parent: &lt;%=parentpath%&gt;).&quot;</span>,
    <span class="hljs-attr">date$</span>:       <span class="hljs-string">&quot;The property &#x27;&lt;%=property%&gt;&#x27;, with current value: &#x27;&lt;%=value%&gt;&#x27;, must be a date (parent: &lt;%=parentpath%&gt;).&quot;</span>,
    <span class="hljs-attr">array$</span>:      <span class="hljs-string">&quot;The property &#x27;&lt;%=property%&gt;&#x27;, with current value: &#x27;&lt;%=value%&gt;&#x27;, must be a array (parent: &lt;%=parentpath%&gt;).&quot;</span>,
    <span class="hljs-attr">object$</span>:     <span class="hljs-string">&quot;The property &#x27;&lt;%=property%&gt;&#x27;, with current value: &#x27;&lt;%=value%&gt;&#x27;, must be a object (parent: &lt;%=parentpath%&gt;).&quot;</span>,
    <span class="hljs-attr">function$</span>:   <span class="hljs-string">&quot;The property &#x27;&lt;%=property%&gt;&#x27;, with current value: &#x27;&lt;%=value%&gt;&#x27;, must be a function (parent: &lt;%=parentpath%&gt;).&quot;</span>,

    <span class="hljs-attr">only$</span>:       <span class="hljs-string">&quot;The property &#x27;&lt;%=property%&gt;&#x27; is not recognised here. Recognised properties are: &lt;%=rule.spec%&gt; (parent: &lt;%=parentpath%&gt;).&quot;</span>,

    <span class="hljs-attr">wild$</span>:       <span class="hljs-string">&quot;The value &lt;%=value%&gt; does not match the expression &#x27;&lt;%=rule.spec%&gt;&#x27; (parent: &lt;%=parentpath%&gt;).&quot;</span>,
    <span class="hljs-attr">re$</span>:         <span class="hljs-string">&quot;The value &lt;%=value%&gt; does not match the regular expression &lt;%=rule.spec%&gt; (parent: &lt;%=parentpath%&gt;).&quot;</span>,
    <span class="hljs-attr">type$</span>:       <span class="hljs-string">&quot;The value &lt;%=value%&gt; is not of type &#x27;&lt;%=rule.spec%&gt;&#x27; (parent: &lt;%=parentpath%&gt;).&quot;</span>,
    <span class="hljs-attr">format$</span>:     <span class="hljs-string">&quot;The value &lt;%=value%&gt; is not of format &#x27;&lt;%=rule.spec%&gt;&#x27; (parent: &lt;%=parentpath%&gt;).&quot;</span>,

    <span class="hljs-attr">minlen$</span>:     <span class="hljs-string">&quot;The property &#x27;&lt;%=property%&gt;&#x27;, with current value: &#x27;&lt;%=value%&gt;&#x27;, must have minimum length &#x27;&lt;%=rule.spec%&gt;&#x27; (parent: &lt;%=parentpath%&gt;).&quot;</span>,
    <span class="hljs-attr">maxlen$</span>:     <span class="hljs-string">&quot;The property &#x27;&lt;%=property%&gt;&#x27;, with current value: &#x27;&lt;%=value%&gt;&#x27;, must have maximum length &#x27;&lt;%=rule.spec%&gt;&#x27; (parent: &lt;%=parentpath%&gt;).&quot;</span>,

    <span class="hljs-attr">eq$</span>:         <span class="hljs-string">&quot;The value &lt;%=value%&gt; does not equal &#x27;&lt;%=rule.spec%&gt;&#x27; (parent: &lt;%=parentpath%&gt;).&quot;</span>,
    <span class="hljs-attr">lt$</span>:         <span class="hljs-string">&quot;The value &lt;%=value%&gt; is not less than &#x27;&lt;%=rule.spec%&gt;&#x27; (parent: &lt;%=parentpath%&gt;).&quot;</span>,
    <span class="hljs-attr">lte$</span>:        <span class="hljs-string">&quot;The value &lt;%=value%&gt; is not less than or equal with &#x27;&lt;%=rule.spec%&gt;&#x27; (parent: &lt;%=parentpath%&gt;).&quot;</span>,
    <span class="hljs-attr">gt$</span>:         <span class="hljs-string">&quot;The value &lt;%=value%&gt; is not greater than &#x27;&lt;%=rule.spec%&gt;&#x27; (parent: &lt;%=parentpath%&gt;).&quot;</span>,
    <span class="hljs-attr">gte$</span>:        <span class="hljs-string">&quot;The value &lt;%=value%&gt; is not not greater than or equal with &#x27;&lt;%=rule.spec%&gt;&#x27; (parent: &lt;%=parentpath%&gt;).&quot;</span>,
    <span class="hljs-attr">min$</span>:        <span class="hljs-string">&quot;The value &lt;%=value%&gt; is not not greater than or equal with &#x27;&lt;%=rule.spec%&gt;&#x27; (parent: &lt;%=parentpath%&gt;).&quot;</span>,
    <span class="hljs-attr">max$</span>:        <span class="hljs-string">&quot;The value &lt;%=value%&gt; is not less than or equal with &#x27;&lt;%=rule.spec%&gt;&#x27; (parent: &lt;%=parentpath%&gt;).&quot;</span>,
    <span class="hljs-attr">uniq$</span>:       <span class="hljs-string">&quot;The value &lt;%=value%&gt; has duplicate elements.&quot;</span>,
    <span class="hljs-attr">enum$</span>:       <span class="hljs-string">&quot;The value &lt;%=value%&gt; must be one of &#x27;&lt;%=rule.spec%&gt;&#x27; (parent: &lt;%=parentpath%&gt;).&quot;</span>

  }




  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clone</span>(<span class="hljs-params">ctxt</span>) </span>{
    <span class="hljs-keyword">var</span> newctxt = {
      <span class="hljs-attr">rules</span>:ctxt.rules,
      <span class="hljs-attr">point</span>:ctxt.point,
      <span class="hljs-attr">msgs</span>:ctxt.msgs,
      <span class="hljs-attr">log</span>:ctxt.log,
      <span class="hljs-attr">parents</span>:ctxt.parents,
      <span class="hljs-attr">util</span>:ctxt.util
    }
    <span class="hljs-keyword">return</span> newctxt;
  }


  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">formatparents</span>(<span class="hljs-params">parents,topname</span>) </span>{
    <span class="hljs-keyword">var</span> out = topname || <span class="hljs-string">&#x27;top level&#x27;</span>
    <span class="hljs-keyword">if</span>( <span class="hljs-number">0</span> &lt; parents.length ) {
      out = _.map(parents,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">p</span>)</span>{<span class="hljs-keyword">return</span> p.prop}).join(<span class="hljs-string">&#x27;.&#x27;</span>)
      <span class="hljs-keyword">if</span>( topname ) {
        out = topname+<span class="hljs-string">&#x27;.&#x27;</span>+out
      }
    }

    <span class="hljs-keyword">return</span> out
  }


  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">killcircles</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> seen = []
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">k,v</span>)</span>{
      <span class="hljs-keyword">if</span>( (_.includes||_.contains)(seen,v) ) <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;[CIRCULAR-REFERENCE]&#x27;</span>;
      seen.push(v)
      <span class="hljs-keyword">return</span> v
    }
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fail</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> code = <span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>]
    <span class="hljs-keyword">var</span> ctxt = <span class="hljs-built_in">arguments</span>[<span class="hljs-number">1</span>]
    <span class="hljs-keyword">var</span> cb   = <span class="hljs-built_in">arguments</span>[<span class="hljs-number">2</span>]

    <span class="hljs-keyword">if</span>( !cb ) {
      ctxt = <span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>]
      cb   = <span class="hljs-built_in">arguments</span>[<span class="hljs-number">1</span>]
      code = ctxt.rule.name
    }

    <span class="hljs-keyword">if</span>(!cb) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">&#x27;Parambulator: ctxt.util.fail: callback undefined&#x27;</span>)
    }

    <span class="hljs-keyword">if</span>(!ctxt) {
      <span class="hljs-keyword">return</span> cb(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">&#x27;Parambulator: ctxt.util.fail: ctxt undefined&#x27;</span>))
    }

    <span class="hljs-keyword">var</span> inserts = {
      <span class="hljs-attr">property</span>:ctxt.prop,
      <span class="hljs-attr">value</span>:ctxt.value||<span class="hljs-built_in">JSON</span>.stringify(ctxt.point,killcircles()),
      <span class="hljs-attr">point</span>:ctxt.point,
      <span class="hljs-attr">rule</span>:ctxt.rule,
      <span class="hljs-attr">parentpath</span>:ctxt.util.formatparents(ctxt.parents),
      <span class="hljs-attr">json</span>:<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">v</span>)</span>{<span class="hljs-keyword">return</span> <span class="hljs-built_in">JSON</span>.stringify(v,killcircles())}
    }

    <span class="hljs-keyword">var</span> msg = ctxt.msgs[code] || code

    <span class="hljs-keyword">if</span>( _.isFunction(msg) ) {
      msg = msg(inserts,ctxt)
    }
    <span class="hljs-keyword">else</span> {
      msg = ctxt.util.msgmods( msg )
      msg = _.template(msg)(inserts)
    }

    <span class="hljs-keyword">var</span> err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>( msg )

    err.parambulator = {
      <span class="hljs-attr">code</span>:     code,
      <span class="hljs-attr">property</span>: ctxt.prop,
      <span class="hljs-attr">value</span>:    ctxt.point,
      <span class="hljs-attr">expected</span>: (ctxt.rule ? ctxt.rule.spec : <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>),
      <span class="hljs-attr">parents</span>:  ctxt.parents,
      <span class="hljs-attr">point</span>:    ctxt.point,
      <span class="hljs-attr">rule</span>:     ctxt.rule}
    <span class="hljs-keyword">return</span> cb(err)
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Return an ordered array of property names. The prefix __ is removed
from property names, both in the returned array, and the original
object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">proporder</span>(<span class="hljs-params">obj</span>) </span>{
    <span class="hljs-keyword">var</span> pn = []
    <span class="hljs-keyword">for</span>( <span class="hljs-keyword">var</span> p <span class="hljs-keyword">in</span> obj ) {
      <span class="hljs-keyword">var</span> pc = p
      <span class="hljs-keyword">if</span>( <span class="hljs-number">0</span> === p.indexOf(<span class="hljs-string">&#x27;__&#x27;</span>) ) {
        pc = p.substring(<span class="hljs-number">2</span>)
        obj[pc] = obj[p]
        <span class="hljs-keyword">delete</span> obj[p]
      }
      pn.push(pc)
    }
    <span class="hljs-keyword">return</span> pn
  }


  <span class="hljs-comment">/*

   name$ -&gt; rule name
   name  -&gt; property names

   */</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Parambulator</span>(<span class="hljs-params"> spec, pref </span>) </span>{
    <span class="hljs-keyword">var</span> self = {}
    pref = pref || {}
    <span class="hljs-keyword">var</span> defaultrules = []

    <span class="hljs-keyword">if</span>( _.isString(spec) ) {
      spec = jsonic(spec)
    }

    <span class="hljs-keyword">if</span>( !spec || !_.isObject(spec) || _.isArray(spec) ) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">&#x27;Parambulator: spec argument is not an object&#x27;</span>)
    }

    <span class="hljs-keyword">if</span>( _.cloneDeep ) {
      spec = _.cloneDeep(spec)
    }

    <span class="hljs-keyword">if</span>( pref ) {
      <span class="hljs-keyword">if</span>( exp.ownprefs ) {
        exp.ownprefs.validate(pref,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>)</span>{
          <span class="hljs-keyword">if</span>( err ) <span class="hljs-keyword">throw</span> err;
        })
      }

      <span class="hljs-keyword">if</span>( pref.valid &amp;&amp; exp ) {
        <span class="hljs-keyword">var</span> prefparams = exp({<span class="hljs-string">&#x27;**&#x27;</span>:pref.valid})
        prefparams.validate(spec,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>)</span>{
          <span class="hljs-keyword">if</span>( err ) <span class="hljs-keyword">throw</span> err;
        })
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>var rulenames = proporder(spec)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> rules = parse(spec)
    parsedefault(spec, [], [])


    self.toString = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">JSON</span>.stringify(rules)
    }


    <span class="hljs-comment">/*
     * Example:
     * For a: {default$:123, type$:&#x27;number&#x27;}
     * creates {&quot;pathnames&quot;:[&quot;a&quot;],&quot;pathtypes&quot;:[],&quot;defaultvalue&quot;:123}
     *
     * for d: {type$: &#x27;array&#x27;, __0: {default$:&#x27;arraytest0&#x27;}}
     * creates {&quot;pathnames&quot;:[&quot;d&quot;,&quot;0&quot;],&quot;pathtypes&quot;:[&quot;array&quot;],&quot;defaultvalue&quot;:&quot;arraytest0&quot;}
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parsedefault</span>(<span class="hljs-params">spec, path, pathtypes</span>)</span>{
      <span class="hljs-keyword">var</span> innerulenames = []
      <span class="hljs-keyword">var</span> currentruletype = <span class="hljs-string">&#x27;object&#x27;</span>

      <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> name <span class="hljs-keyword">in</span> spec){
        <span class="hljs-keyword">if</span>(spec.hasOwnProperty(name)) {
          <span class="hljs-keyword">var</span> rule = spec[name]
          <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;default$&#x27;</span> == name){
            <span class="hljs-keyword">var</span> defaultrule = {}
            defaultrule.pathnames = path

            defaultrule.pathtypes = pathtypes.splice(<span class="hljs-number">1</span>,pathtypes.length)
            defaultrule.defaultvalue = rule
            defaultrules.push(defaultrule)
          }
          <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;type$&#x27;</span> == name){
            currentruletype = rule
          }
          <span class="hljs-keyword">if</span>( _.isObject(rule) &amp;&amp; !_.isArray(rule) ) {
            innerulenames.push(name)
          }
        }
      }

      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> index <span class="hljs-keyword">in</span> innerulenames){
        <span class="hljs-keyword">if</span>(innerulenames.hasOwnProperty(index)) {
          <span class="hljs-keyword">var</span> inner_rule = spec[innerulenames[index]]

          <span class="hljs-keyword">var</span> newpath = path.slice()
          newpath.push(innerulenames[index])

          <span class="hljs-keyword">var</span> newpathtypes = pathtypes.slice()
          newpathtypes.push(currentruletype)
          parsedefault(inner_rule, newpath, newpathtypes)
        }
      }
    }


    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">buildrule</span>(<span class="hljs-params">name,rulespec</span>) </span>{
      <span class="hljs-keyword">var</span> func = (pref &amp;&amp; pref.rules) ? pref.rules[name] : <span class="hljs-literal">null</span>
      <span class="hljs-keyword">if</span>( !func ) {
        func = rulemap[name]
      }

      <span class="hljs-keyword">if</span>( func ) {
        <span class="hljs-keyword">var</span> rule = {
          <span class="hljs-attr">func</span>:func,
          <span class="hljs-attr">name</span>:name,
          <span class="hljs-attr">spec</span>:rulespec
        }
        <span class="hljs-keyword">return</span> rule
      }
      <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">&quot;Parambulator: Unknown rule: &quot;</span>+name)
      }
    }


    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parse</span>(<span class="hljs-params">spec</span>) </span>{
      <span class="hljs-keyword">var</span> rules = []
      <span class="hljs-keyword">var</span> names = proporder(spec)
      _.each(names, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>)</span>{
        <span class="hljs-keyword">var</span> rulespec = spec[name]</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>enables multiple rules of same name</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span>( <span class="hljs-string">&#x27;list$&#x27;</span> == name ) {
          <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; rulespec.length; i++) {
            <span class="hljs-keyword">var</span> rs = {}
            rs[rulespec[i][<span class="hljs-number">0</span>]]=rulespec[i][<span class="hljs-number">1</span>]
            rules.push(parse(rs)[<span class="hljs-number">0</span>])
          }
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>enables quoting of property names that end in $</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( <span class="hljs-string">&#x27;prop$&#x27;</span> == name ) {
          <span class="hljs-keyword">var</span> subrules = parse( rulespec.rules )
          <span class="hljs-keyword">var</span> rule = buildrule(<span class="hljs-string">&#x27;descend$&#x27;</span>,{<span class="hljs-attr">prop</span>:rulespec.name,<span class="hljs-attr">rules</span>:subrules})
          rules.push(rule)
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>its a rule - name$ syntax</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( name.match(<span class="hljs-regexp">/\$$/</span>) ) {
          <span class="hljs-keyword">if</span>((name === <span class="hljs-string">&#x27;required$&#x27;</span> || name === <span class="hljs-string">&#x27;notempty$&#x27;</span>) &amp;&amp; 
             pref.multiErrors &amp;&amp; 
             _.isArray(rulespec)) 
          {
            _.each(rulespec, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{
              <span class="hljs-keyword">var</span> item_rule = buildrule(name,[item],spec)
              rules.push(item_rule)
            })
          } 
          <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">var</span> build_rule = buildrule(name,rulespec,spec)
            rules.push(build_rule)
          }
        }


        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( <span class="hljs-string">&#x27;**&#x27;</span> == name ) {
          <span class="hljs-keyword">var</span> starstar_subrules = parse( rulespec )
          <span class="hljs-keyword">var</span> starstar_rule = 
                buildrule(<span class="hljs-string">&#x27;recurse$&#x27;</span>,{<span class="hljs-attr">prop</span>:name,<span class="hljs-attr">rules</span>:starstar_subrules})
          rules.push(starstar_rule)
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>its a property</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">if</span>( _.isObject(rulespec) &amp;&amp; !_.isArray(rulespec) ) {

            _.each( rulespec, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">v,p</span>)</span>{
              <span class="hljs-keyword">if</span>( p.match(<span class="hljs-regexp">/\$$/</span>) &amp;&amp; _.isBoolean(v) &amp;&amp; v ) {
                <span class="hljs-keyword">var</span> rule = buildrule(p,name,spec)
                rules.push(rule)
                <span class="hljs-keyword">delete</span> rulespec[p]
              }
            })

            <span class="hljs-keyword">var</span> prop_subrules = parse( rulespec )
            <span class="hljs-keyword">var</span> prop_rule = buildrule(<span class="hljs-string">&#x27;iterate$&#x27;</span>,{<span class="hljs-attr">prop</span>:name,<span class="hljs-attr">rules</span>:prop_subrules})
            rules.push(prop_rule)
          }


          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( _.isString(rulespec) ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>foo:required$</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span>( rulespec.match(<span class="hljs-regexp">/\$/</span>) ) {
              <span class="hljs-keyword">var</span> rulespecs = rulespec.split(<span class="hljs-regexp">/\s*,\s*/</span>)
              _.each( rulespecs, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"> rulespec </span>) </span>{
                rules.push( buildrule(rulespec,name) )
              })
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>foo:bar*</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">else</span> {
              rules.push( buildrule(<span class="hljs-string">&#x27;descend$&#x27;</span>,{
                <span class="hljs-attr">prop</span>:name,<span class="hljs-attr">rules</span>:[buildrule(<span class="hljs-string">&#x27;wild$&#x27;</span>,rulespec)]
              }))
            }
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>TODO: else check for other types, and use eq$ !!!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( _.isNumber(rulespec) ) {
            rules.push( buildrule(<span class="hljs-string">&#x27;descend$&#x27;</span>,{
              <span class="hljs-attr">prop</span>:name,<span class="hljs-attr">rules</span>:[buildrule(<span class="hljs-string">&#x27;eq$&#x27;</span>,rulespec)]
            }))
          }

          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( _.isBoolean(rulespec) ) {
            rules.push( buildrule(<span class="hljs-string">&#x27;descend$&#x27;</span>,{
              <span class="hljs-attr">prop</span>:name,<span class="hljs-attr">rules</span>:[buildrule(<span class="hljs-string">&#x27;eq$&#x27;</span>,rulespec)]
            }))
          }

          <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">&quot;Parambulator: Unrecognized rule specification: &quot;</span>+rulespec)
          }
        }

      })

      <span class="hljs-keyword">return</span> rules
    }


    <span class="hljs-keyword">var</span> msgs = _.extend({},msgsmap,pref?pref.msgs:<span class="hljs-literal">null</span>)


    self.validate = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"> args, cb </span>) </span>{
      <span class="hljs-keyword">var</span> reterr
      <span class="hljs-keyword">var</span> callback = pref.callbackmaker ? pref.callbackmaker(cb) : (cb||<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{})
      <span class="hljs-keyword">var</span> wrapcb = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>)</span>{
        reterr=err</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>console.log(VALIDATE, JSON.stringify(arguments), arrayify(arguments))</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        callback.apply(<span class="hljs-literal">null</span>,<span class="hljs-built_in">arguments</span>)
      }
      <span class="hljs-keyword">var</span> errors = []


      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">execrules</span>(<span class="hljs-params">ctxt,cb</span>) </span>{
        <span class="hljs-keyword">if</span>( _.isUndefined(args) ) {
          <span class="hljs-keyword">return</span> fail(<span class="hljs-string">&#x27;no_input$&#x27;</span>,ctxt,cb)
        }

        <span class="hljs-keyword">var</span> rules = ctxt.rules

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">execrule</span>(<span class="hljs-params">ruleI</span>) </span>{
          <span class="hljs-keyword">if</span>( ruleI &lt; rules.length ) {
            <span class="hljs-keyword">var</span> rule = rules[ruleI]

            <span class="hljs-keyword">if</span>( !ctxt.point ) {
              <span class="hljs-keyword">return</span> execrule(ruleI+<span class="hljs-number">1</span>)
            }

            ctxt.rule = rule

            <span class="hljs-keyword">var</span> specstr = <span class="hljs-built_in">JSON</span>.stringify(rule.spec,killcircles())

            ctxt.log.push(<span class="hljs-string">&#x27;rule:&#x27;</span>+rule.name+<span class="hljs-string">&#x27;:exec:&#x27;</span>+specstr)

            rule.func(ctxt, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
              <span class="hljs-keyword">if</span>( err ) {
                <span class="hljs-keyword">if</span>(_.isArray(err)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>huh !?
errors = errors.concat(err)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                } <span class="hljs-keyword">else</span> {
                  errors.push(err)
                  ctxt.log.push(<span class="hljs-string">&#x27;rule:&#x27;</span>+rule.name+<span class="hljs-string">&#x27;:fail:&#x27;</span>+specstr)
                }
                execrule(ruleI+<span class="hljs-number">1</span>)
              }
              <span class="hljs-keyword">else</span> {
                ctxt.log.push(<span class="hljs-string">&#x27;rule:&#x27;</span>+rule.name+<span class="hljs-string">&#x27;:pass:&#x27;</span>+specstr)
                execrule(ruleI+<span class="hljs-number">1</span>)
              }
            })
          }
          <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span>(errors.length &gt; <span class="hljs-number">0</span> &amp;&amp; pref.multiErrors) {
              cb(errors,{<span class="hljs-attr">log</span>:ctxt.log})
            } <span class="hljs-keyword">else</span> {
              <span class="hljs-keyword">var</span> err = errors.length &gt; <span class="hljs-number">0</span> ? errors[<span class="hljs-number">0</span>] : <span class="hljs-literal">null</span>;
              cb(err,{<span class="hljs-attr">log</span>:ctxt.log})
            }

          }
        }

        execrule(<span class="hljs-number">0</span>)
      }

      <span class="hljs-comment">/*
       * Example:
       * For a: {&quot;pathnames&quot;:[&quot;a&quot;],&quot;pathtypes&quot;:[],&quot;defaultvalue&quot;:123}
       * creates {a:123}
       *
       * for d: {&quot;pathnames&quot;:[&quot;d&quot;,&quot;0&quot;],&quot;pathtypes&quot;:[&quot;array&quot;],&quot;defaultvalue&quot;:&quot;arraytest0&quot;}
       * creates {d: [&#x27;arraytest0&#x27;]}
       */</span>
      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">validatedefaults</span>(<span class="hljs-params">ctxt, cb</span>)</span>{
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> ruleindex <span class="hljs-keyword">in</span> defaultrules){
          <span class="hljs-keyword">var</span> rule = defaultrules[ruleindex]
          <span class="hljs-keyword">var</span> obj = ctxt.point

          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> index <span class="hljs-keyword">in</span> rule.pathnames){
            <span class="hljs-keyword">var</span> location = rule.pathnames[index]
            <span class="hljs-keyword">if</span> ( !_.has(obj, location) ){</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>if is last in path then just add default value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">if</span> (index == rule.pathnames.length - <span class="hljs-number">1</span>){
                obj[location] = rule.defaultvalue
              }</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>else create object or array and continue following path</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">else</span>{
                <span class="hljs-keyword">var</span> type = rule.pathtypes[index]
                <span class="hljs-keyword">var</span> newobj
                <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;object&#x27;</span> == type){
                  newobj = {}
                }
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;array&#x27;</span> == type){
                  newobj = []
                }
                <span class="hljs-keyword">else</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>cannot continue, call cb and return false;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                  ctxt.util.fail(<span class="hljs-string">&#x27;default$&#x27;</span>,ctxt,cb)
                  <span class="hljs-keyword">return</span>;
                }
                obj[location] = newobj
                obj = newobj
              }
            }
            <span class="hljs-keyword">else</span>{
              obj = obj[location]
            }
          }
        }
        cb();
      }

      <span class="hljs-keyword">var</span> ctxt = {<span class="hljs-attr">rules</span>:rules,<span class="hljs-attr">point</span>:args,<span class="hljs-attr">msgs</span>:msgs,<span class="hljs-attr">log</span>:[],<span class="hljs-attr">parents</span>:[]}
      ctxt.util = {
        <span class="hljs-attr">formatparents</span>:<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
          <span class="hljs-keyword">var</span> args = arrayify(<span class="hljs-built_in">arguments</span>)
          args[<span class="hljs-number">1</span>] = pref &amp;&amp; pref.topname &amp;&amp; !args[<span class="hljs-number">1</span>] ? pref.topname : args[<span class="hljs-number">1</span>]
          <span class="hljs-keyword">return</span> formatparents.apply(<span class="hljs-literal">null</span>,args)
        },
        <span class="hljs-attr">msgmods</span>:<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">msg</span>) </span>{
          <span class="hljs-keyword">return</span> (pref.msgprefix||<span class="hljs-string">&#x27;&#x27;</span>) + msg + (pref.msgsuffix||<span class="hljs-string">&#x27;&#x27;</span>)
        },
        <span class="hljs-attr">fail</span>:fail,<span class="hljs-attr">proplist</span>:proplist,<span class="hljs-attr">execrules</span>:execrules,<span class="hljs-attr">clone</span>:clone}

      validatedefaults(ctxt,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>)</span>{
        <span class="hljs-keyword">if</span> (err){
          wrapcb(err,{<span class="hljs-attr">log</span>:ctxt.log})
        }
        <span class="hljs-keyword">else</span> {
          execrules(ctxt,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>)</span>{
            wrapcb(err,{<span class="hljs-attr">log</span>:ctxt.log})
          })
        }
      })</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>only works if no async calls inside rules</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">return</span> reterr
    }


    <span class="hljs-keyword">return</span> self
  }


  <span class="hljs-keyword">var</span> exp = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
    <span class="hljs-keyword">var</span> args = arrayify(<span class="hljs-built_in">arguments</span>)
    <span class="hljs-keyword">return</span> Parambulator.apply(<span class="hljs-built_in">this</span>,args)
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>this is where Parambulator validates its own input</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  exp.ownparams = <span class="hljs-keyword">new</span> Parambulator({
    <span class="hljs-string">&#x27;**&#x27;</span>:
    {
      <span class="hljs-attr">strings$</span>: [<span class="hljs-string">&#x27;required$&#x27;</span>,<span class="hljs-string">&#x27;notempty$&#x27;</span>,<span class="hljs-string">&#x27;atmostone$&#x27;</span>,<span class="hljs-string">&#x27;exactlyone$&#x27;</span>,<span class="hljs-string">&#x27;atleastone$&#x27;</span>],
      <span class="hljs-attr">list$</span>:[
        [<span class="hljs-string">&#x27;prop$&#x27;</span>,{<span class="hljs-attr">name</span>:<span class="hljs-string">&#x27;wild$&#x27;</span>, <span class="hljs-attr">rules</span>:{<span class="hljs-attr">type$</span>:<span class="hljs-string">&#x27;string&#x27;</span>}}],
        [<span class="hljs-string">&#x27;prop$&#x27;</span>,{<span class="hljs-attr">name</span>:<span class="hljs-string">&#x27;type$&#x27;</span>, <span class="hljs-attr">rules</span>:{<span class="hljs-attr">type$</span>:[<span class="hljs-string">&#x27;string&#x27;</span>,<span class="hljs-string">&#x27;array&#x27;</span>]}}],
        [<span class="hljs-string">&#x27;prop$&#x27;</span>,{<span class="hljs-attr">name</span>:<span class="hljs-string">&#x27;format$&#x27;</span>, <span class="hljs-attr">rules</span>:{<span class="hljs-attr">type$</span>:[<span class="hljs-string">&#x27;string&#x27;</span>,<span class="hljs-string">&#x27;array&#x27;</span>]}}],
        [<span class="hljs-string">&#x27;prop$&#x27;</span>,{<span class="hljs-attr">name</span>:<span class="hljs-string">&#x27;re$&#x27;</span>,   <span class="hljs-attr">rules</span>:{<span class="hljs-attr">type$</span>:<span class="hljs-string">&#x27;string&#x27;</span>}}],

        [<span class="hljs-string">&#x27;prop$&#x27;</span>,{<span class="hljs-attr">name</span>:<span class="hljs-string">&#x27;type$&#x27;</span>, <span class="hljs-attr">rules</span>:{<span class="hljs-attr">enum$</span>:[<span class="hljs-string">&#x27;string&#x27;</span>,<span class="hljs-string">&#x27;number&#x27;</span>,<span class="hljs-string">&#x27;integer&#x27;</span>,<span class="hljs-string">&#x27;boolean&#x27;</span>,<span class="hljs-string">&#x27;date&#x27;</span>,<span class="hljs-string">&#x27;array&#x27;</span>,<span class="hljs-string">&#x27;object&#x27;</span>,]}}],
        [<span class="hljs-string">&#x27;prop$&#x27;</span>,{<span class="hljs-attr">name</span>:<span class="hljs-string">&#x27;format$&#x27;</span>, <span class="hljs-attr">rules</span>:{<span class="hljs-attr">enum$</span>:[<span class="hljs-string">&#x27;datetime&#x27;</span>,<span class="hljs-string">&#x27;date&#x27;</span>,<span class="hljs-string">&#x27;time&#x27;</span>,<span class="hljs-string">&#x27;utcmillisec&#x27;</span>, <span class="hljs-string">&#x27;re&#x27;</span>]}}],

        [<span class="hljs-string">&#x27;prop$&#x27;</span>,{<span class="hljs-attr">name</span>:<span class="hljs-string">&#x27;minlen$&#x27;</span>, <span class="hljs-attr">rules</span>:{<span class="hljs-attr">type$</span>:<span class="hljs-string">&#x27;number&#x27;</span>}}],
        [<span class="hljs-string">&#x27;prop$&#x27;</span>,{<span class="hljs-attr">name</span>:<span class="hljs-string">&#x27;maxlen$&#x27;</span>, <span class="hljs-attr">rules</span>:{<span class="hljs-attr">type$</span>:<span class="hljs-string">&#x27;number&#x27;</span>}}],

        [<span class="hljs-string">&#x27;prop$&#x27;</span>,{<span class="hljs-attr">name</span>:<span class="hljs-string">&#x27;enum$&#x27;</span>, <span class="hljs-attr">rules</span>:{<span class="hljs-attr">type$</span>:<span class="hljs-string">&#x27;array&#x27;</span>}}],
        [<span class="hljs-string">&#x27;prop$&#x27;</span>,{<span class="hljs-attr">name</span>:<span class="hljs-string">&#x27;list$&#x27;</span>, <span class="hljs-attr">rules</span>:{<span class="hljs-attr">type$</span>:<span class="hljs-string">&#x27;array&#x27;</span>}}],</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>This can work only after #1 is implemented
these should also work for strings, right?
     [prop$,{name:lt$,  rules:{type$:[number,date]}}],
     [prop$,{name:lte$, rules:{type$:[number,date]}}],
     [prop$,{name:gt$,  rules:{type$:[number,date]}}],
     [prop$,{name:gte$, rules:{type$:[number,date]}}],
     [prop$,{name:min$, rules:{type$:[number,date]}}],
     [prop$,{name:max$, rules:{type$:[number,date]}}],</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        [<span class="hljs-string">&#x27;prop$&#x27;</span>,{<span class="hljs-attr">name</span>:<span class="hljs-string">&#x27;uniq$&#x27;</span>, <span class="hljs-attr">rules</span>:{<span class="hljs-attr">type$</span>:<span class="hljs-string">&#x27;array&#x27;</span>}}]
      ]
    }
  }, {
    <span class="hljs-attr">__ownparams__</span>:<span class="hljs-literal">true</span>,
    <span class="hljs-attr">rules</span>: {
      <span class="hljs-attr">strings$</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ctxt,cb</span>)</span>{
        <span class="hljs-keyword">var</span> pn = ctxt.rule.spec

        <span class="hljs-keyword">if</span>( !_.isArray(pn) ) {
          pn = [<span class="hljs-string">&#x27;&#x27;</span>+pn]
        }

        <span class="hljs-keyword">for</span>( <span class="hljs-keyword">var</span> pI = <span class="hljs-number">0</span>; pI &lt; pn.length; pI++ ) {
          <span class="hljs-keyword">var</span> p   = pn[pI]
          <span class="hljs-keyword">var</span> val = ctxt.point[p]

          <span class="hljs-keyword">if</span>( !_.isUndefined(val) ) {
            <span class="hljs-keyword">if</span>( _.isString(val) ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>ok</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( _.isArray(val) ) {
              <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; val.length; i++ ) {
                <span class="hljs-keyword">if</span>( !_.isString(val[i]) ) {
                  ctxt.prop = p
                  <span class="hljs-keyword">return</span> ctxt.util.fail(ctxt,cb)
                }
              }
            }
            <span class="hljs-keyword">else</span> {
              ctxt.prop = p
              <span class="hljs-keyword">return</span> ctxt.util.fail(ctxt,cb)
            }
          }
        }

        cb(<span class="hljs-literal">null</span>)
      }
    },
    <span class="hljs-attr">msgs</span>: {
      <span class="hljs-string">&#x27;strings$&#x27;</span>: <span class="hljs-string">&#x27;The &lt;%=property%&gt; rule needs a string or array of strings (property: &lt;%=parentpath%&gt;).&#x27;</span>
    },
    <span class="hljs-attr">topname</span>:<span class="hljs-string">&#x27;spec&#x27;</span>
  })</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>validate preferences</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  exp.ownprefs = <span class="hljs-keyword">new</span> Parambulator({
    <span class="hljs-attr">object$</span>:[<span class="hljs-string">&#x27;valid&#x27;</span>,<span class="hljs-string">&#x27;rules&#x27;</span>,<span class="hljs-string">&#x27;msgs&#x27;</span>],
    <span class="hljs-attr">string$</span>:[<span class="hljs-string">&#x27;topname&#x27;</span>,<span class="hljs-string">&#x27;msgprefix&#x27;</span>,<span class="hljs-string">&#x27;msgsuffix&#x27;</span>],
    <span class="hljs-attr">boolean$</span>:[<span class="hljs-string">&#x27;multiErrors&#x27;</span>],
    <span class="hljs-attr">function$</span>:[<span class="hljs-string">&#x27;callbackmaker&#x27;</span>],
    <span class="hljs-attr">only$</span>:[<span class="hljs-string">&#x27;valid&#x27;</span>,<span class="hljs-string">&#x27;rules&#x27;</span>,<span class="hljs-string">&#x27;msgs&#x27;</span>, <span class="hljs-string">&#x27;topname&#x27;</span>,<span class="hljs-string">&#x27;msgprefix&#x27;</span>,<span class="hljs-string">&#x27;msgsuffix&#x27;</span>, <span class="hljs-string">&#x27;multiErrors&#x27;</span>, <span class="hljs-string">&#x27;callbackmaker&#x27;</span>]
  },{
    <span class="hljs-attr">topname</span>:<span class="hljs-string">&#x27;prefs&#x27;</span>
  })

  exp.Parambulator = Parambulator</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>module.exports = exp</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>


  root.parambulator = exp

  exp.noConflict = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    root.parambulator = previous_parambulator;
    <span class="hljs-keyword">return</span> self;
  }


  <span class="hljs-keyword">if</span>( <span class="hljs-keyword">typeof</span> <span class="hljs-built_in">exports</span> !== <span class="hljs-string">&#x27;undefined&#x27;</span> ) {
    <span class="hljs-keyword">if</span>( <span class="hljs-keyword">typeof</span> <span class="hljs-built_in">module</span> !== <span class="hljs-string">&#x27;undefined&#x27;</span> &amp;&amp; <span class="hljs-built_in">module</span>.exports ) {
      <span class="hljs-built_in">exports</span> = <span class="hljs-built_in">module</span>.exports = exp
    }
    <span class="hljs-built_in">exports</span>.parambulator = exp
  }
  <span class="hljs-keyword">else</span> {
    root.parambulator = exp
  }

}).call(<span class="hljs-built_in">this</span>);</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
