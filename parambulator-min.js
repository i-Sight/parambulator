/* Copyright (c) 2012-2015 Richard Rodger, MIT License */
(function(){"use strict";var e=this,r=e.parambulator,t="undefined"!=typeof require,d=e._,n=e.gex,a=e.jsonic;if(void 0===d){if(!t)throw new Error("parambulator requires underscore, see http://underscorejs.org");d=require("lodash")}if(void 0===n){if(!t)throw new Error("parambulator requires gex, see http://github.com/rjrodger/gex");n=require("gex")}if(void 0===a){if(!t)throw new Error("parambulator requires jsonic, see http://github.com/rjrodger/jsonic");a=require("jsonic")}function u(a,e){return function(r,e){r.prop=null;var t=r.util.proplist(r),n=0;return d.each(t,function(e){n+=r.point[e]?1:0}),a(n)?e():(r.value=""+t,r.util.fail(r,e))}}function i(u){return function(e,r){var t=e.rule.spec,n=e.point;if(!d.isUndefined(n)){var a=d.isObject(n)?Object.keys(n).length:n.length;if(!d.isUndefined(a)&&!u(a,t))return e.util.fail(e,r)}return r()}}function o(i,o,e){return function(e,r){for(var t=e.util.proplist(e),n=0;n<t.length;n++){var a=t[n];e.prop=a;var u=e.point[a];if(!i(e,a,u))return e.value=u,e.util.fail(e,r)}if(0===t.length&&!o())return e.prop=JSON.stringify(e.rule.spec,b()),e.util.fail(e,r);r()}}var s=function(){return Array.prototype.slice.call(arguments[0],arguments[1])};function c(r){var e=r.rule.spec;d.isArray(e)||(e=[""+e]);var t=[];return d.each(e,function(e){e.match(/[*?]/)?t=t.concat(d.keys(n(e).on(r.point))):t.push(e)}),t}function p(){return!0}function l(e){return d.isUndefined(e)||d.isNull(e)}function f(a){return function(e,r){var t=e.point,n=e.rule.spec;return d.isUndefined(t)||a(t,n)?r():e.util.fail(e,r)}}var m={atmostone$:u(function(e){return e<=1}),exactlyone$:u(function(e){return 1==e}),atleastone$:u(function(e){return 1<=e}),required$:o(function(e,r,t){return!d.isUndefined(t)},function(){return!1}),notempty$:o(function(e,r,t){return!d.isUndefined(t)&&!d.isNull(t)&&""!==t},p),string$:o(function(e,r,t){return l(t)||d.isString(t)},p),integer$:o(function(e,r,t){return l(t)||d.isNumber(t)&&t===(0|t)},p),number$:o(function(e,r,t){return l(t)||d.isNumber(t)},p),boolean$:o(function(e,r,t){return l(t)||d.isBoolean(t)},p),date$:o(function(e,r,t){return l(t)||d.isDate(t)},p),array$:o(function(e,r,t){return l(t)||d.isArray(t)},p),object$:o(function(e,r,t){return l(t)||d.isObject(t)&&!d.isArray(t)},p),function$:o(function(e,r,t){return l(t)||d.isFunction(t)},p),lt$:f(function(e,r){return e<r}),lte$:f(function(e,r){return e<=r}),gt$:f(function(e,r){return r<e}),gte$:f(function(e,r){return r<=e}),min$:f(function(e,r){return r<=e}),max$:f(function(e,r){return e<=r}),uniq$:function(e,r){for(var t=e.point,n={},a=0;a<t.length;a++){if(d.has(n,t[a]))return e.util.fail(e,r);n[t[a]]=1}return r()},only$:function(e,r){var t=e.util.proplist(e);for(var n in e.point)if(!(d.includes||d.contains)(t,n))return e.prop=n,e.util.fail(e,r);return r()},wild$:function(e,r){var t=e.point;return d.isUndefined(t)||n(e.rule.spec).on(t)?r():e.util.fail(e,r)},eq$:function(e,r){var t=e.point;return d.isUndefined(t)||e.rule.spec===t?r():e.util.fail(e,r)},minlen$:i(function(e,r){return r<=e}),maxlen$:i(function(e,r){return e<=r}),re$:function(e,r){var t=e.point;if(!d.isUndefined(t)){t=""+t;var n=e.rule.spec,a=void 0,u=/^\/(.*)\/(\w*)$/.exec(e.rule.spec);if(u&&(n=u[1],a=u[2]),!new RegExp(n,a).exec(t))return e.util.fail(e,r)}return r()},type$:function(t,e){var r=t.util.proplist(t),n={string:d.isString,number:d.isNumber,integer:function(e){return d.isNumber(e)&&e===(0|e)},boolean:d.isBoolean,date:d.isDate,array:d.isArray,object:function(e){return d.isObject(e)&&!d.isArray(e)&&!d.isDate(e)},function:function(e){return d.isFunction(e)}},a=0;return d.each(r,function(e){var r=n[e.toLowerCase()];r&&(a+=r(t.point))}),a?e():t.util.fail(t,e)},format$:function(t,e){var r=t.util.proplist(t),n={datetime:function(e){return/\d{4}-(0[1-9]|1[1-2])-([0-2]\d|3[0-1])T([0-1]\d|2[0-4]):[0-5]\d:[0-5]\dZ/.test(e)},date:function(e){return/\d{4}-[0-1][0-2]-[0-2]\d/.test(e)},time:function(e){return/([0-1]\d|2[0-4]):[0-5]\d:[0-5]\dZ/.test(e)},utcmillisec:d.isNumber,re:d.isRegExp},a=0;return d.each(r,function(e){var r=n[e.toLowerCase()];r&&(a+=r(t.point))}),a?e():t.util.fail(t,e)},default$:function(e,r){return r()},enum$:function(e,r){var t=e.point,n=e.rule.spec,a=[];d.isArray(t)?a=t:a[0]=t;var u=0;return a&&d.each(a,function(e){u+=-1==n.indexOf(e)}),u?e.util.fail(e,r):r()},iterate$:function(a,u){var i=[a.rule.spec.prop];d.isObject(a.point)&&(i=d.isArray(a.point)?n(a.rule.spec.prop).on(d.range(a.point.length)):d.keys(n(a.rule.spec.prop).on(a.point)));var o=a.util.clone(a);o.rules=a.rule.spec.rules,function r(t){var e,n;t<i.length?(e=i[t],(n=a.util.clone(o)).parents=o.parents.concat({prop:e,point:o.point}),n.prop=e,n.point=o.point?o.point[e]:null,n.util.execrules(n,function(e){return e?u(e):void r(t+1)})):u()}(0)},recurse$:function(t,e){var r=t.util.clone(t);r.point={$:t.point},function u(e,i,r){if(!d.isObject(i))return r(null);var o=d.keys(i);var p=t.util.clone(t);p.rules=t.rule.spec.rules;p.parents="$"!=e?p.parents.concat({prop:p.prop,point:p.point}):p.parents;function l(r,t){if(!(r<o.length))return t(null);var n=o[r],a=p.util.clone(p);a.prop=n,a.point=i[n],a.parents="$"!=n?a.parents.concat({prop:p.prop,point:p.point}):a.parents,a.util.execrules(a,function(e){return e?t(e):void u(n,a.point,function(e){return e?t(e):void l(r+1,t)})})}l(0,r)}("$",r.point,e)},descend$:function(e,r){var t=e.util.clone(e),n=e.rule.spec.prop;t.rules=e.rule.spec.rules,t.prop=n,t.point=e.point[n],t.parents=t.parents.concat({prop:n,point:e.point}),t.util.execrules(t,function(e){return e?r(e):void r(null)})}},g={no_input$:"There is no input parameter",atmostone$:"At most one of these properties can be used at a time: '<%=value%>'  (parent: <%=parentpath%>).",exactlyone$:"Exactly one of these properties must be used: '<%=value%>' (parent: <%=parentpath%>).",atleastone$:"At least one of these properties is required: '<%=value%>' (parent: <%=parentpath%>).",required$:"The property '<%=property%>' is missing and is always required (parent: <%=parentpath%>).",notempty$:"The property '<%=property%>' requires a value (parent: <%=parentpath%>).",string$:"The property '<%=property%>', with current value: '<%=value%>', must be a string (parent: <%=parentpath%>).",integer$:"The property '<%=property%>', with current value: '<%=value%>', must be a integer (parent: <%=parentpath%>).",number$:"The property '<%=property%>', with current value: '<%=value%>', must be a number (parent: <%=parentpath%>).",boolean$:"The property '<%=property%>', with current value: '<%=value%>', must be a boolean (parent: <%=parentpath%>).",date$:"The property '<%=property%>', with current value: '<%=value%>', must be a date (parent: <%=parentpath%>).",array$:"The property '<%=property%>', with current value: '<%=value%>', must be a array (parent: <%=parentpath%>).",object$:"The property '<%=property%>', with current value: '<%=value%>', must be a object (parent: <%=parentpath%>).",function$:"The property '<%=property%>', with current value: '<%=value%>', must be a function (parent: <%=parentpath%>).",only$:"The property '<%=property%>' is not recognised here. Recognised properties are: <%=rule.spec%> (parent: <%=parentpath%>).",wild$:"The value <%=value%> does not match the expression '<%=rule.spec%>' (parent: <%=parentpath%>).",re$:"The value <%=value%> does not match the regular expression <%=rule.spec%> (parent: <%=parentpath%>).",type$:"The value <%=value%> is not of type '<%=rule.spec%>' (parent: <%=parentpath%>).",format$:"The value <%=value%> is not of format '<%=rule.spec%>' (parent: <%=parentpath%>).",minlen$:"The property '<%=property%>', with current value: '<%=value%>', must have minimum length '<%=rule.spec%>' (parent: <%=parentpath%>).",maxlen$:"The property '<%=property%>', with current value: '<%=value%>', must have maximum length '<%=rule.spec%>' (parent: <%=parentpath%>).",eq$:"The value <%=value%> does not equal '<%=rule.spec%>' (parent: <%=parentpath%>).",lt$:"The value <%=value%> is not less than '<%=rule.spec%>' (parent: <%=parentpath%>).",lte$:"The value <%=value%> is not less than or equal with '<%=rule.spec%>' (parent: <%=parentpath%>).",gt$:"The value <%=value%> is not greater than '<%=rule.spec%>' (parent: <%=parentpath%>).",gte$:"The value <%=value%> is not not greater than or equal with '<%=rule.spec%>' (parent: <%=parentpath%>).",min$:"The value <%=value%> is not not greater than or equal with '<%=rule.spec%>' (parent: <%=parentpath%>).",max$:"The value <%=value%> is not less than or equal with '<%=rule.spec%>' (parent: <%=parentpath%>).",uniq$:"The value <%=value%> has duplicate elements.",enum$:"The value <%=value%> must be one of '<%=rule.spec%>' (parent: <%=parentpath%>)."};function y(e){return{rules:e.rules,point:e.point,msgs:e.msgs,log:e.log,parents:e.parents,util:e.util}}function b(){var t=[];return function(e,r){return(d.includes||d.contains)(t,r)?"[CIRCULAR-REFERENCE]":(t.push(r),r)}}function w(){var e=arguments[0],r=arguments[1],t=arguments[2];if(t||(t=arguments[1],e=(r=arguments[0]).rule.name),!t)throw new Error("Parambulator: ctxt.util.fail: callback undefined");if(!r)return t(new Error("Parambulator: ctxt.util.fail: ctxt undefined"));var n={property:r.prop,value:r.value||JSON.stringify(r.point,b()),point:r.point,rule:r.rule,parentpath:r.util.formatparents(r.parents),json:function(e){return JSON.stringify(e,b())}},a=r.msgs[e]||e,a=d.isFunction(a)?a(n,r):(a=r.util.msgmods(a),d.template(a)(n)),u=new Error(a);return u.parambulator={code:e,property:r.prop,value:r.point,expected:r.rule?r.rule.spec:void 0,parents:r.parents,point:r.point,rule:r.rule},t(u)}function x(e){var r=[];for(var t in e){var n=t;0===t.indexOf("__")&&(e[n=t.substring(2)]=e[t],delete e[t]),r.push(n)}return r}function h(e,v){var r={};v=v||{};var h=[];if(d.isString(e)&&(e=a(e)),!e||!d.isObject(e)||d.isArray(e))throw new Error("Parambulator: spec argument is not an object");d.cloneDeep&&(e=d.cloneDeep(e)),v&&(T.ownprefs&&T.ownprefs.validate(v,function(e){if(e)throw e}),v.valid&&T&&T({"**":v.valid}).validate(e,function(e){if(e)throw e}));var o=function f(h){var m=[];var e=x(h);d.each(e,function(n){var e,r,a=h[n];if("list$"==n)for(var t=0;t<a.length;t++){var u={};u[a[t][0]]=a[t][1],m.push(f(u)[0])}else if("prop$"==n){var i=f(a.rules),o=$("descend$",{prop:a.name,rules:i});m.push(o)}else if(n.match(/\$$/)){("required$"===n||"notempty$"===n)&&v.multiErrors&&d.isArray(a)?d.each(a,function(e){var r=$(n,[e]);m.push(r)}):(e=$(n,a),m.push(e))}else if("**"==n){var p=f(a),l=$("recurse$",{prop:n,rules:p});m.push(l)}else if(d.isObject(a)&&!d.isArray(a)){d.each(a,function(e,r){var t;r.match(/\$$/)&&d.isBoolean(e)&&e&&(t=$(r,n),m.push(t),delete a[r])});var s=f(a),c=$("iterate$",{prop:n,rules:s});m.push(c)}else if(d.isString(a)){a.match(/\$/)?(r=a.split(/\s*,\s*/),d.each(r,function(e){m.push($(e,n))})):m.push($("descend$",{prop:n,rules:[$("wild$",a)]}))}else if(d.isNumber(a))m.push($("descend$",{prop:n,rules:[$("eq$",a)]}));else{if(!d.isBoolean(a))throw new Error("Parambulator: Unrecognized rule specification: "+a);m.push($("descend$",{prop:n,rules:[$("eq$",a)]}))}});return m}(e);function $(e,r){var t=v&&v.rules?v.rules[e]:null;if(t=t||m[e])return{func:t,name:e,spec:r};throw new Error("Parambulator: Unknown rule: "+e)}!function e(r,t,n){var a=[];var u="object";for(var i in r){var o,p;r.hasOwnProperty(i)&&(o=r[i],"default$"==i&&((p={}).pathnames=t,p.pathtypes=n.splice(1,n.length),p.defaultvalue=o,h.push(p)),"type$"==i&&(u=o),d.isObject(o)&&!d.isArray(o)&&a.push(i))}for(var l in a){var s,c,f;a.hasOwnProperty(l)&&(s=r[a[l]],(c=t.slice()).push(a[l]),(f=n.slice()).push(u),e(s,c,f))}}(e,[],[]),r.toString=function(){return JSON.stringify(o)};var l=d.extend({},g,v?v.msgs:null);return r.validate=function(e,r){function t(e){n=e,a.apply(null,arguments)}var n,a=v.callbackmaker?v.callbackmaker(r):r||function(){},p=[];function u(u,i){if(d.isUndefined(e))return w("no_input$",u,i);var o=u.rules;!function r(t){if(t<o.length){var n=o[t];if(!u.point)return r(t+1);u.rule=n;var a=JSON.stringify(n.spec,b());u.log.push("rule:"+n.name+":exec:"+a),n.func(u,function(e){e?d.isArray(e)||(p.push(e),u.log.push("rule:"+n.name+":fail:"+a)):u.log.push("rule:"+n.name+":pass:"+a),r(t+1)})}else{var e;0<p.length&&v.multiErrors?i(p,{log:u.log}):(e=0<p.length?p[0]:null,i(e,{log:u.log}))}}(0)}var i={rules:o,point:e,msgs:l,log:[],parents:[]};return i.util={formatparents:function(){var e=s(arguments);return e[1]=v&&v.topname&&!e[1]?v.topname:e[1],function(e,r){var t=r||"top level";return 0<e.length&&(t=d.map(e,function(e){return e.prop}).join("."),r&&(t=r+"."+t)),t}.apply(null,e)},msgmods:function(e){return(v.msgprefix||"")+e+(v.msgsuffix||"")},fail:w,proplist:c,execrules:u,clone:y},function(e,r){for(var t in h){var n=h[t],a=e.point;for(var u in n.pathnames){var i=n.pathnames[u];if(d.has(a,i))a=a[i];else if(u==n.pathnames.length-1)a[i]=n.defaultvalue;else{var o,p=n.pathtypes[u];if("object"==p)o={};else{if("array"!=p)return e.util.fail("default$",e,r);o=[]}a[i]=o,a=o}}}r()}(i,function(e){e?t(e,{log:i.log}):u(i,function(e){t(e,{log:i.log})})}),n},r}var T=function(){var e=s(arguments);return h.apply(this,e)};T.ownparams=new h({"**":{strings$:["required$","notempty$","atmostone$","exactlyone$","atleastone$"],list$:[["prop$",{name:"wild$",rules:{type$:"string"}}],["prop$",{name:"type$",rules:{type$:["string","array"]}}],["prop$",{name:"format$",rules:{type$:["string","array"]}}],["prop$",{name:"re$",rules:{type$:"string"}}],["prop$",{name:"type$",rules:{enum$:["string","number","integer","boolean","date","array","object"]}}],["prop$",{name:"format$",rules:{enum$:["datetime","date","time","utcmillisec","re"]}}],["prop$",{name:"minlen$",rules:{type$:"number"}}],["prop$",{name:"maxlen$",rules:{type$:"number"}}],["prop$",{name:"enum$",rules:{type$:"array"}}],["prop$",{name:"list$",rules:{type$:"array"}}],["prop$",{name:"uniq$",rules:{type$:"array"}}]]}},{__ownparams__:!0,rules:{strings$:function(e,r){var t=e.rule.spec;d.isArray(t)||(t=[""+t]);for(var n=0;n<t.length;n++){var a=t[n],u=e.point[a];if(!d.isUndefined(u)&&!d.isString(u)){if(!d.isArray(u))return e.prop=a,e.util.fail(e,r);for(var i=0;i<u.length;i++)if(!d.isString(u[i]))return e.prop=a,e.util.fail(e,r)}}r(null)}},msgs:{strings$:"The <%=property%> rule needs a string or array of strings (property: <%=parentpath%>)."},topname:"spec"}),T.ownprefs=new h({object$:["valid","rules","msgs"],string$:["topname","msgprefix","msgsuffix"],boolean$:["multiErrors"],function$:["callbackmaker"],only$:["valid","rules","msgs","topname","msgprefix","msgsuffix","multiErrors","callbackmaker"]},{topname:"prefs"}),T.Parambulator=h,(e.parambulator=T).noConflict=function(){return e.parambulator=r,self},"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=T),exports.parambulator=T):e.parambulator=T}).call(this);